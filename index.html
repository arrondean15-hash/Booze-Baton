<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIFA Fines Tracker - Booze Baton</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            background: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            margin-right: 10px;
            margin-top: 10px;
        }

        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #e74c3c;
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
        }

        .btn-success:hover {
            background: #229954;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
        }

        .fines-table {
            width: 100%;
            overflow-x: auto;
            display: block;
        }

        .fines-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .fines-table th,
        .fines-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .fines-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }

        .fines-table tr:hover {
            background: #f8f9fa;
        }

        .delete-btn, .paid-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            margin-right: 5px;
        }

        .delete-btn:hover {
            background: #c0392b;
        }

        .paid-btn {
            background: #27ae60;
        }

        .paid-btn:hover {
            background: #229954;
        }

        .paid-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .paid-status.paid {
            background: #d4edda;
            color: #155724;
        }

        .paid-status.unpaid {
            background: #f8d7da;
            color: #721c24;
        }

        .player-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .player-name {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .player-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .player-stat {
            display: flex;
            flex-direction: column;
        }

        .player-stat-label {
            font-size: 0.85em;
            color: #777;
            margin-bottom: 4px;
        }

        .player-stat-value {
            font-size: 1.1em;
            font-weight: 600;
            color: #667eea;
        }

        .fine-reason {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .chart-container {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .chart-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .bar-chart {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .bar-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .bar-label {
            min-width: 120px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .bar-wrapper {
            flex: 1;
            background: #e0e0e0;
            height: 30px;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: 600;
            font-size: 0.85em;
            transition: width 0.5s ease;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .import-area {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            background: #f8f9fa;
        }

        .import-instructions {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .csv-preview {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
        }

        #fileInput {
            display: none;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }
            
            .content {
                padding: 20px;
            }

            .stat-value {
                font-size: 1.5em;
            }

            .tabs {
                overflow-x: auto;
            }

            .fines-table {
                font-size: 0.9em;
            }

            .bar-label {
                min-width: 80px;
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚öΩ FIFA Fines Tracker</h1>
            <div class="subtitle">Booze Baton - Live Updates</div>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('add')">‚ûï Add Fine</button>
            <button class="tab" onclick="switchTab('stats')">üìä Stats</button>
            <button class="tab" onclick="switchTab('charts')">üìà Charts</button>
            <button class="tab" onclick="switchTab('history')">üìã History</button>
            <button class="tab" onclick="switchTab('players')">üë• Players</button>
            <button class="tab" onclick="switchTab('import')">üì• Import</button>
        </div>

        <div class="content">
            <!-- Add Fine Tab -->
            <div id="add" class="tab-content active">
                <h2 style="margin-bottom: 25px;">Log a New Fine</h2>
                <form id="fineForm">
                    <div class="form-group">
                        <label for="playerName">Player Name</label>
                        <input type="text" id="playerName" list="playersList" placeholder="Enter player name" required>
                        <datalist id="playersList"></datalist>
                    </div>

                    <div class="form-group">
                        <label for="fineReason">Fine Reason</label>
                        <select id="fineReason" required onchange="updateAmount()">
                            <option value="">Select a fine...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="fineAmount">Amount (¬£)</label>
                        <input type="number" id="fineAmount" step="0.01" placeholder="0.00" required>
                    </div>

                    <div class="form-group">
                        <label for="fineDate">Date</label>
                        <input type="date" id="fineDate" required>
                    </div>

                    <div class="form-group">
                        <label for="gamesPlayed">Games Played (this session)</label>
                        <input type="number" id="gamesPlayed" min="0" placeholder="0" value="1">
                    </div>

                    <button type="submit" class="btn">Add Fine</button>
                </form>
            </div>

            <!-- Stats Tab -->
            <div id="stats" class="tab-content">
                <h2 style="margin-bottom: 25px;">Club Stats</h2>
                <div id="statsLoading" class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading stats...</p>
                </div>
                <div id="statsContent" style="display: none;">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Total Fine Pot</div>
                            <div class="stat-value" id="totalPot">¬£0.00</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Unpaid</div>
                            <div class="stat-value" id="totalUnpaid">¬£0.00</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Fines</div>
                            <div class="stat-value" id="totalFines">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Worst Offender</div>
                            <div class="stat-value" id="worstOffender" style="font-size: 1.3em;">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Tab -->
            <div id="charts" class="tab-content">
                <h2 style="margin-bottom: 25px;">Visual Analytics</h2>
                <div id="chartsLoading" class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading charts...</p>
                </div>
                <div id="chartsContent" style="display: none;">
                    <div class="chart-container">
                        <div class="chart-title">üèÜ Total Fines by Player</div>
                        <div id="playerFinesChart" class="bar-chart"></div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-title">üìä Number of Fines by Player</div>
                        <div id="finesCountChart" class="bar-chart"></div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-title">üí∞ Unpaid Fines by Player</div>
                        <div id="unpaidChart" class="bar-chart"></div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-title">üéÆ Fines Per Game</div>
                        <div id="finesPerGameChart" class="bar-chart"></div>
                    </div>
                </div>
            </div>

            <!-- History Tab -->
            <div id="history" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 10px;">
                    <h2>Fine History</h2>
                    <button class="btn btn-danger" onclick="clearAllFines()">Clear All</button>
                </div>
                <div id="historyLoading" class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading history...</p>
                </div>
                <div id="historyContent" style="display: none;"></div>
            </div>

            <!-- Players Tab -->
            <div id="players" class="tab-content">
                <h2 style="margin-bottom: 25px;">Player Breakdown</h2>
                <div id="playersLoading" class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading players...</p>
                </div>
                <div id="playersContent" style="display: none;"></div>
            </div>

            <!-- Import CSV Tab -->
            <div id="import" class="tab-content">
                <h2 style="margin-bottom: 25px;">Import Existing Fines</h2>
                
                <div class="import-area">
                    <div class="import-instructions">
                        <strong>How to import your existing fines:</strong><br>
                        1. Export your spreadsheet as CSV<br>
                        2. Make sure it has columns: Name, Date, Fine, Amount, Paid (optional)<br>
                        3. Click the button below to select your CSV file
                    </div>
                    <input type="file" id="fileInput" accept=".csv" onchange="handleFileSelect(event)">
                    <button class="btn" onclick="document.getElementById('fileInput').click()">
                        Choose CSV File
                    </button>
                </div>

                <div id="importAlert"></div>
                <div id="csvPreview" class="csv-preview"></div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, onSnapshot, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBixQ-BIuklK7p9Im-jnRzokXgoIJ7petI",
            authDomain: "booze-baton.firebaseapp.com",
            projectId: "booze-baton",
            storageBucket: "booze-baton.firebasestorage.app",
            messagingSenderId: "988291694611",
            appId: "1:988291694611:web:84f4e54eca2fccba733fe6",
            measurementId: "G-CSWQY9K2HD"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Fine reasons
        const fineReasons = [
            { reason: "10 minutes late", amount: 2.00 },
            { reason: "Not declaring availability by 6.30pm (via poll)", amount: 2.50 },
            { reason: "No show after declaring available", amount: 5.00 },
            { reason: "Rage Quit", amount: 4.00 },
            { reason: "Being a worst", amount: 1.00 },
            { reason: "Not passing on a 2-1 and not scoring", amount: 2.00 },
            { reason: "Avoidable mistake leading to a goal", amount: 2.00 },
            { reason: "Red card", amount: 1.00 },
            { reason: "Unnecessary red card", amount: 2.00 },
            { reason: "Not attending booze baton", amount: 100.00 },
            { reason: "Fucking a lead (worst fine for each player responsible)", amount: 1.00 },
            { reason: "Losing 3 in a row (¬£2 per player)", amount: 2.00 },
            { reason: "Losing after 3 in a row", amount: 1.00 },
            { reason: "Obscene Spacker (Cost Benidorm Utd Win or Draw)", amount: 2.00 },
            { reason: "Average Rating Following Defeat", amount: 2.00 },
            { reason: "First Half Red Card", amount: 3.00 },
            { reason: "Spirit of Booze baton", amount: 4.00 },
            { reason: "Repeatedly bringing up old fines", amount: 2.00 },
            { reason: "Unavailable (Sunday to Thursday)", amount: 5.00 },
            { reason: "3 Goal Loss", amount: 1.00 },
            { reason: "Each Goal after 3 goals (¬£1 per goal)", amount: 1.00 },
            { reason: "Away from Controller", amount: 3.00 },
            { reason: "Rating Fine (6.0 - 6.4)", amount: 1.00 },
            { reason: "Rating Fine (5.9 and below)", amount: 2.00 },
            { reason: "Team Agreed quit Game", amount: 1.00 }
        ];

        let allFines = [];

        // Make functions globally available
        window.switchTab = switchTab;
        window.updateAmount = updateAmount;
        window.deleteFine = deleteFine;
        window.togglePaid = togglePaid;
        window.clearAllFines = clearAllFines;
        window.handleFileSelect = handleFileSelect;

        function init() {
            populateFineReasons();
            setDefaultDate();
            setupFormHandler();
            setupRealtimeListener();
        }

        function populateFineReasons() {
            const select = document.getElementById('fineReason');
            fineReasons.forEach(fine => {
                const option = document.createElement('option');
                option.value = fine.reason;
                option.textContent = `${fine.reason} - ¬£${fine.amount.toFixed(2)}`;
                option.dataset.amount = fine.amount;
                select.appendChild(option);
            });
        }

        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fineDate').value = today;
        }

        function updateAmount() {
            const select = document.getElementById('fineReason');
            const amountInput = document.getElementById('fineAmount');
            const selectedOption = select.options[select.selectedIndex];
            if (selectedOption.dataset.amount) {
                amountInput.value = selectedOption.dataset.amount;
            }
        }

        function setupFormHandler() {
            document.getElementById('fineForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const fine = {
                    playerName: document.getElementById('playerName').value.trim(),
                    reason: document.getElementById('fineReason').value,
                    amount: parseFloat(document.getElementById('fineAmount').value),
                    date: document.getElementById('fineDate').value,
                    gamesPlayed: parseInt(document.getElementById('gamesPlayed').value) || 0,
                    paid: false,
                    paidDate: null,
                    timestamp: new Date().toISOString()
                };

                try {
                    await addDoc(collection(db, 'fines'), fine);
                    e.target.reset();
                    setDefaultDate();
                    document.getElementById('gamesPlayed').value = '1';
                    alert(`Fine added for ${fine.playerName}! üéØ`);
                } catch (error) {
                    console.error('Error:', error);
                    alert('Failed to add fine.');
                }
            });
        }

        function setupRealtimeListener() {
            const q = query(collection(db, 'fines'), orderBy('timestamp', 'desc'));
            onSnapshot(q, (snapshot) => {
                allFines = [];
                snapshot.forEach((d) => {
                    allFines.push({ id: d.id, ...d.data() });
                });
                updateAll();
            });
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            updateAll();
        }

        function updateAll() {
            updateStats();
            updateCharts();
            updateHistory();
            updatePlayers();
            updatePlayersList();
        }

        function updateStats() {
            const totalPot = allFines.reduce((sum, fine) => sum + fine.amount, 0);
            const totalUnpaid = allFines.filter(f => !f.paid).reduce((sum, fine) => sum + fine.amount, 0);

            document.getElementById('totalPot').textContent = `¬£${totalPot.toFixed(2)}`;
            document.getElementById('totalUnpaid').textContent = `¬£${totalUnpaid.toFixed(2)}`;
            document.getElementById('totalFines').textContent = allFines.length;

            const playerTotals = {};
            allFines.forEach(fine => {
                playerTotals[fine.playerName] = (playerTotals[fine.playerName] || 0) + fine.amount;
            });
            
            const worstOffender = Object.entries(playerTotals).sort((a, b) => b[1] - a[1])[0];
            document.getElementById('worstOffender').textContent = worstOffender ? 
                `${worstOffender[0]} (¬£${worstOffender[1].toFixed(2)})` : '-';

            document.getElementById('statsLoading').style.display = 'none';
            document.getElementById('statsContent').style.display = 'block';
        }

        function updateCharts() {
            if (allFines.length === 0) {
                document.getElementById('chartsLoading').style.display = 'none';
                document.getElementById('chartsContent').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <h3>No data yet!</h3>
                    </div>
                `;
                return;
            }

            const playerTotals = {};
            const playerCounts = {};
            const playerGames = {};
            const playerUnpaid = {};

            allFines.forEach(fine => {
                playerTotals[fine.playerName] = (playerTotals[fine.playerName] || 0) + fine.amount;
                playerCounts[fine.playerName] = (playerCounts[fine.playerName] || 0) + 1;
                playerGames[fine.playerName] = (playerGames[fine.playerName] || 0) + (fine.gamesPlayed || 0);
                if (!fine.paid) {
                    playerUnpaid[fine.playerName] = (playerUnpaid[fine.playerName] || 0) + fine.amount;
                }
            });

            renderBarChart('playerFinesChart', playerTotals, '¬£');
            renderBarChart('finesCountChart', playerCounts, '');
            renderBarChart('unpaidChart', playerUnpaid, '¬£');
            
            const finesPerGame = {};
            Object.keys(playerTotals).forEach(player => {
                if (playerGames[player] > 0) {
                    finesPerGame[player] = (playerTotals[player] / playerGames[player]);
                }
            });
            renderBarChart('finesPerGameChart', finesPerGame, '¬£', true);

            document.getElementById('chartsLoading').style.display = 'none';
            document.getElementById('chartsContent').style.display = 'block';
        }

        function renderBarChart(containerId, data, prefix = '', isDecimal = false) {
            const container = document.getElementById(containerId);
            const sorted = Object.entries(data).sort((a, b) => b[1] - a[1]);
            const maxValue = Math.max(...sorted.map(([, val]) => val));

            container.innerHTML = sorted.map(([name, value]) => {
                const percentage = (value / maxValue) * 100;
                const displayValue = isDecimal ? value.toFixed(2) : value;
                return `
                    <div class="bar-item">
                        <div class="bar-label">${name}</div>
                        <div class="bar-wrapper">
                            <div class="bar-fill" style="width: ${percentage}%">
                                ${prefix}${displayValue}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateHistory() {
            const historyContent = document.getElementById('historyContent');
            
            if (allFines.length === 0) {
                historyContent.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <h3>No fines yet!</h3>
                    </div>
                `;
                document.getElementById('historyLoading').style.display = 'none';
                historyContent.style.display = 'block';
                return;
            }

            const sortedFines = [...allFines].sort((a, b) => new Date(b.date) - new Date(a.date));

            historyContent.innerHTML = `
                <div class="fines-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Player</th>
                                <th>Reason</th>
                                <th>Amount</th>
                                <th>Games</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sortedFines.map(fine => `
                                <tr>
                                    <td>${new Date(fine.date).toLocaleDateString()}</td>
                                    <td>${fine.playerName}</td>
                                    <td>${fine.reason}</td>
                                    <td>¬£${fine.amount.toFixed(2)}</td>
                                    <td>${fine.gamesPlayed || 0}</td>
                                    <td>
                                        <span class="paid-status ${fine.paid ? 'paid' : 'unpaid'}">
                                            ${fine.paid ? '‚úì Paid' : '‚úó Unpaid'}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="paid-btn" onclick="togglePaid('${fine.id}', ${!fine.paid})">
                                            ${fine.paid ? 'Unpaid' : 'Paid'}
                                        </button>
                                        <button class="delete-btn" onclick="deleteFine('${fine.id}')">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('historyLoading').style.display = 'none';
            historyContent.style.display = 'block';
        }

        function updatePlayers() {
            const playersContent = document.getElementById('playersContent');
            
            if (allFines.length === 0) {
                playersContent.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üë•</div>
                        <h3>No players yet!</h3>
                    </div>
                `;
                document.getElementById('playersLoading').style.display = 'none';
                playersContent.style.display = 'block';
                return;
            }

            const playerStats = {};
            allFines.forEach(fine => {
                if (!playerStats[fine.playerName]) {
                    playerStats[fine.playerName] = {
                        total: 0,
                        unpaid: 0,
                        count: 0,
                        games: 0,
                        reasons: {}
                    };
                }
                playerStats[fine.playerName].total += fine.amount;
                if (!fine.paid) {
                    playerStats[fine.playerName].unpaid += fine.amount;
                }
                playerStats[fine.playerName].count += 1;
                playerStats[fine.playerName].games += (fine.gamesPlayed || 0);
                playerStats[fine.playerName].reasons[fine.reason] = 
                    (playerStats[fine.playerName].reasons[fine.reason] || 0) + 1;
            });

            const sortedPlayers = Object.entries(playerStats).sort((a, b) => b[1].total - a[1].total);

            playersContent.innerHTML = sortedPlayers.map(([name, stats]) => {
                const topReasons = Object.entries(stats.reasons)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 3);
                
                const finesPerGame = stats.games > 0 ? (stats.total / stats.games).toFixed(2) : '0.00';

                return `
                    <div class="player-card">
                        <div class="player-name">${name}</div>
                        <div class="player-stats">
                            <div class="player-stat">
                                <span class="player-stat-label">Total Fines</span>
                                <span class="player-stat-value">¬£${stats.total.toFixed(2)}</span>
                            </div>
                            <div class="player-stat">
                                <span class="player-stat-label">Unpaid</span>
                                <span class="player-stat-value">¬£${stats.unpaid.toFixed(2)}</span>
                            </div>
                            <div class="player-stat">
                                <span class="player-stat-label">Number of Fines</span>
                                <span class="player-stat-value">${stats.count}</span>
                            </div>
                            <div class="player-stat">
                                <span class="player-stat-label">Games Played</span>
                                <span class="player-stat-value">${stats.games}</span>
                            </div>
                            <div class="player-stat">
                                <span class="player-stat-label">Fines Per Game</span>
                                <span class="player-stat-value">¬£${finesPerGame}</span>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                            <div style="font-size: 0.9em; color: #777; margin-bottom: 8px;">Most Common Fines:</div>
                            ${topReasons.map(([reason, count]) => `
                                <div class="fine-reason">
                                    <span>${reason}</span>
                                    <span style="color: #667eea; font-weight: 600;">${count}x</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('playersLoading').style.display = 'none';
            playersContent.style.display = 'block';
        }

        function updatePlayersList() {
            const playersList = document.getElementById('playersList');
            const uniquePlayers = [...new Set(allFines.map(f => f.playerName))];
            playersList.innerHTML = uniquePlayers.map(name => 
                `<option value="${name}">`
            ).join('');
        }

        async function togglePaid(id, paid) {
            try {
                const fineRef = doc(db, 'fines', id);
                await updateDoc(fineRef, {
                    paid: paid,
                    paidDate: paid ? new Date().toISOString() : null
                });
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to update.');
            }
        }

        async function deleteFine(id) {
            if (confirm('Delete this fine?')) {
                try {
                    await deleteDoc(doc(db, 'fines', id));
                } catch (error) {
                    console.error('Error:', error);
                    alert('Failed to delete.');
                }
            }
        }

        async function clearAllFines() {
            if (confirm('Clear ALL fines? Cannot be undone!')) {
                try {
                    const snapshot = await getDocs(collection(db, 'fines'));
                    const deletePromises = snapshot.docs.map(d => deleteDoc(d.ref));
                    await Promise.all(deletePromises);
                    alert('All fines cleared! üóëÔ∏è');
                } catch (error) {
                    console.error('Error:', error);
                    alert('Failed to clear.');
                }
            }
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                await parseAndImportCSV(e.target.result);
            };
            reader.readAsText(file);
        }

        async function parseAndImportCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
                showImportAlert('CSV file is empty or invalid.', 'error');
                return;
            }

            const headers = lines[0].toLowerCase().split(',').map(h => h.trim());
            const nameIndex = headers.findIndex(h => h.includes('name'));
            const dateIndex = headers.findIndex(h => h.includes('date'));
            const fineIndex = headers.findIndex(h => h.includes('fine') && !h.includes('amount'));
            const amountIndex = headers.findIndex(h => h.includes('amount'));
            const paidIndex = headers.findIndex(h => h.includes('paid'));

            if (nameIndex === -1 || dateIndex === -1 || fineIndex === -1 || amountIndex === -1) {
                showImportAlert('CSV must have: Name, Date, Fine, Amount', 'error');
                return;
            }

            const fines = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                
                const fine = {
                    playerName: values[nameIndex],
                    date: formatDate(values[dateIndex]),
                    reason: values[fineIndex],
                    amount: parseFloat(values[amountIndex].replace(/[¬£$,]/g, '')),
                    paid: paidIndex !== -1 ? (values[paidIndex] && values[paidIndex] !== '') : false,
                    paidDate: null,
                    gamesPlayed: 0,
                    timestamp: new Date().toISOString()
                };

                if (fine.playerName && fine.date && fine.reason && !isNaN(fine.amount)) {
                    fines.push(fine);
                }
            }

            if (fines.length === 0) {
                showImportAlert('No valid fines found.', 'error');
                return;
            }

            showCSVPreview(fines);

            try {
                for (const fine of fines) {
                    await addDoc(collection(db, 'fines'), fine);
                }
                showImportAlert(`Imported ${fines.length} fines! üéâ`, 'success');
                document.getElementById('csvPreview').innerHTML = '';
            } catch (error) {
                console.error('Error:', error);
                showImportAlert('Failed to import.', 'error');
            }
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            if (!isNaN(date.getTime())) {
                return date.toISOString().split('T')[0];
            }
            
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                const [day, month, year] = parts;
                return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            }
            
            return new Date().toISOString().split('T')[0];
        }

        function showCSVPreview(fines) {
            const preview = document.getElementById('csvPreview');
            preview.innerHTML = `
                <h3 style="padding: 15px;">Preview (first 10):</h3>
                <div class="fines-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Player</th>
                                <th>Date</th>
                                <th>Reason</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${fines.slice(0, 10).map(fine => `
                                <tr>
                                    <td>${fine.playerName}</td>
                                    <td>${fine.date}</td>
                                    <td>${fine.reason}</td>
                                    <td>¬£${fine.amount.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function showImportAlert(message, type) {
            const alertDiv = document.getElementById('importAlert');
            alertDiv.innerHTML = `
                <div class="alert alert-${type}">
                    ${message}
                </div>
            `;
            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 5000);
        }

        init();
    </script>
</body>
</html>